# 이메일 발송 

공식문서
* https://docs.djangoproject.com/en/5.2/topics/email/?utm_source=chatgpt.com#topic-email-backends

## send_email

```python
# django.core.mail.send_mail()

send_mail(
    subject,
    message,
    from_email,
    recipient_list,
    fail_silently=False,
    auth_user=None,
    auth_password=None,
    connection=None,
    html_message=None
)
```
* subject (string)
* message (string)
* from_email (string) 값이 비어있는 경우 settings.py에 정의된 `DEFAULT_FROM_EMAIL`를 사용
* recipient_list (list of string) 각각 이메일 주소를 나타내는 문자열 리스트
* fail_silently (bool) False일 경우 send_email()은 [smtplib.SMTPException](https://docs.python.org/3/library/smtplib.html#smtplib.SMTPException)을 발생시킴 
* auth_user (bool) SMTP 서버 인증에 사용할 사용자 이름, 값이 비어있는 경우 `EMAIL_HOST_USER` 사용
* auth_password (optional) SMTP 서버 인증에 사용할 비밀번호, 값이 비어있는 경우 `EMAIL_HOST_PASSWORD` 사용
* connection: 이메일 백엔드를 지정, 지정하지 않을 경우 기본 백엔드 인스턴스 사용 
* html_message text/plain 콘텐츠 유형 또는 text/html 콘텐츠 유형에 해당


## send_mass_mail()

```python
send_mass_mail(
    datatuple,
    fail_silently=False,
    auth_user=None,
    auth_password=None,
    connection=None
)
```
* datatuple (tuple) : (subject, message, from_email, recipient_list)로 구성된 튜플
* 나머지 옵션들은 send_email과 동일

#### Example

```python
message1 = (
    "Subject here",
    "Here is the message",
    "from@example.com",
    ["first@example.com", "other@example.com"],
)
message2 = (
    "Another Subject",
    "Here is another message",
    "from@example.com",
    ["second@test.com"],
)
send_mass_mail((message1, message2), fail_silently=False)
```

> send_mass_mail()과 send_mail()의 차이점

* send_mail()은 실행될 때마다 새로운 커넥션을 열지만, send_mass_mail()의 경우 모든 메세지에 대해서 동일한 커넥션을 사용하여 이메일 발송을 시도함
* 추가적으로 커넥션을 열고 send_email() 사용하면 동일한 커넥션에서 메일 전송함


```python
with get_connection() as connection: # 커넥션 열고 진행
    html = render_to_string(template_url, context)
    message = EmailMultiAlternatives(
        subject=subject, from_email=from_email, to=[target_email], connection=connection
    )
    message.attach_alternative(html, "text/html")
    message.send() # 여러건에 대해서 포문을 돌면서 이메일을 전송한다고 가정하면 모든 메일 전송이 같은 커넥션에서 실행됨
```

## EmailMessage class

`기본 맥락`
* Django는 Python의 smtplib 위에 가벼운 wrapper를 제공하여 이메일 전송을 더 빠르고 간편하게 만듦 
* 간단한 이메일 전송에는 send_email()함수를 사용하고, 고급 기능이 필요한 경우 EmailMessage 또는 EmailMultiAlternatives 클래스를 이용

## EmailMultiAlternatives class

```python
from django.core.mail import EmailMultiAlternatives
from django.template.loader import render_to_string

text_content = render_to_string("templates/emails/my_email.txt", {"my_variable": 42})
html_content = render_to_string("templates/emails/my_email.html", {"my_variable": 42})

msg = EmailMultiAlternatives(
    "Subject here",
    text_content,
    "from@example.com",
    ["to@example.com"],
    headers={"List-Unsubscribe": "<mailto:unsub@example.com>"},
)
msg.attach_alternative(html_content, "text/html")
msg.send()
```
* EmailMessage를 상속하므로, EMailMessage 기반으로 멀티파트 이메일 구현이 가능
* 1 ) 템플릿으로 일반 텍스트 콘텐츠 렌더링
* 2 ) HTML 콘텐츠 렌더링
* 3 ) EmailMultiAlternatives 인스턴스 생성 (subject, text_content, from_email, to, headers 등 지정)
* 4 ) attach_alternative(html_content, "text/html")로 HTML 콘텐츠 첨부
* 5 ) send()로 전송


  

